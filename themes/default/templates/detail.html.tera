<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ link_name | escape }} · {{ site_title | escape }}</title>
   
    <meta name="description" content="{{ link_name | escape }}{% if link_intro and link_intro != "" %},{{ link_intro | escape }}{% endif %}{% if site_desc and site_desc != "" %},{{ site_desc | escape }}{% endif %}">
    <meta name="keywords" content="{{ link_name | escape }} {% if link_keywords and link_keywords != "" %},{{ link_keywords | escape }}{% endif %}">
    
    <!-- Open Graph Protocol -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="{{ link_name | escape }} · {{ site_title | escape }}">
    <meta property="og:description" content="{{ link_name | escape }}{% if link_intro and link_intro != "" %} - {{ link_intro | escape }}{% endif %}">
    {% if site_url %}<meta property="og:url" content="{{ site_url | escape }}">{% endif %}
    <meta property="og:site_name" content="{{ site_title | escape }}">
    {% if og_image %}<meta property="og:image" content="{{ og_image | escape }}">{% endif %}
    
    <link rel="icon" href="../../assets/favicon-f.svg" type="image/svg+xml">
    <link rel="stylesheet" href="../../assets/styles.css">
  </head>
  <body class="theme-{{ color_scheme }} page-detail">
    <div class="top-actions">
      <button id="toggleTheme" class="btn ghost" title="切换主题">🌓</button>
    </div>
    <header class="navbar">
      <div class="nav-inner">
        <a class="btn ghost small" href="../../">首页</a>
        {% if categories and categories | length > 0 %}
        <nav class="nav-cats" aria-label="链接分类">
          {% for c in categories %}
          <a class="nav-cat" href="../../#cat-{{ c | replace(from=" ", to="-") | escape }}">{{ c }}</a>
          {% endfor %}
        </nav>
        {% endif %}
      </div>
    </header>

    <main class="container">
      <div class="detail-layout">
        <article class="detail-main">
          <div class="detail-header">
            <div class="card-head head-split">
              <div class="head-left">
                {% if link_icon %}
                <img class="icon" src="{{ link_icon | escape }}" alt="">
                {% endif %}
                <div class="title">{{ link_name | escape }}</div>
              </div>
              <div class="head-right header-actions">
                <a class="btn small" id="proceed" target="_self" rel="noopener noreferrer" href="{{ link_url | escape }}">继续前往</a>
                <a class="btn ghost small" href="../../">返回</a>
                <button class="btn ghost small" id="copyLink" data-url="{{ link_url | escape }}">复制链接</button>
                <button class="btn ghost small" id="copyQuote" data-quote="{{ link_name | escape }} - {{ link_url | escape }}">复制引用</button>
                <button class="btn ghost small" id="showQR">二维码</button>
                {% if has_delay %}<button class="btn ghost small" id="cancelAuto" style="display:none;">取消</button>{% endif %}
              </div>
            </div>
            <div class="meta-row">
              <span class="badge risk-{{ risk_class }}">风险等级：{{ risk_label }}</span>
              {% if link_host and link_host != "" %}
              <span class="chip">{{ link_host | escape }}</span>
              {% endif %}
            </div>
            {% if link_intro and link_intro != "" %}
            <div class="tldr">
              <strong>TL;DR</strong>
              <span class="tldr-text">{{ link_intro | escape }}</span>
            </div>
            {% endif %}
            <div class="meta" id="cdWrap" style="display:none;">将于 <strong id="cd">{{ delay_seconds }}</strong> 秒后跳转……</div>
            
            <!-- 提示信息（将“目标信息”与“风险提示”合并为一个便签块） -->
            <div class="side-block">
              <div class="side-title">目标信息</div>
              {% if link_host and link_host != "" %}
              <div class="meta">域名：<code>{{ link_host | escape }}</code></div>
              {% endif %}
              <div class="meta">地址：<code id="targetUrl">{{ link_url | escape }}</code></div>

              <div class="side-title">风险提示</div>
              <div class="desc">
                <ul>
                  <li>确认目标域名是否正确：<code>{{ link_host | escape }}</code></li>
                  <li>优先访问 HTTPS（地址栏应显示锁形标识）。</li>
                  <li>谨慎输入账号、密码、验证码等敏感信息。</li>
                  <li>如来自不明来源，请勿下载或运行可执行文件。</li>
                </ul>
              </div>
            </div>
          </div>

          {% if link_details_html or (link_intro and link_intro != "") %}
          <section class="detail-body-wrap">
            <div id="detailBody" class="prose">
              {% if link_details_html %}
                {{ link_details_html | safe }}
              {% else %}
                <p>{{ link_intro | escape }}</p>
              {% endif %}
            </div>
          </section>
          {% endif %}
        </article>
        
      </div>
    </main>

    <footer class="site-footer">Made with ❤ by <a href="https://github.com/dovenav/dove" target="_blank" rel="noopener noreferrer">dove</a> · <a href="../../sitemap.xml">Sitemap</a> · <a href="../../robots.txt">Robots</a> · v{{ build_version | escape }} ({{ build_time | escape }})</footer>

    <div id="toast" class="toast" role="status" aria-live="polite" hidden></div>
    <div id="qrModal" class="modal" hidden>
      <div class="modal-card">
        <div class="side-title">扫码打开</div>
        <div class="qr-box"><div id="qrImg" aria-label="二维码" role="img"></div></div>
        <div class="meta" style="margin-top:8px; word-break: break-all;"><code>{{ link_url | escape }}</code></div>
        <div class="modal-actions"><button id="closeQR" class="btn small">关闭</button></div>
      </div>
    </div>

    <script src="../../assets/app.js"></script>
    <script src="../../assets/qrcode.min.js"></script>
    <script>
      // Register service worker for offline support
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('../../sw.js')
            .then(function(registration) {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(function(err) {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
    </script>
    <script>
      (function(){
        var hasDelay = {{ has_delay | json_encode | safe }};
        var delay = {{ delay_seconds | json_encode | safe }} || 0;
        var url = {{ link_url | json_encode | safe }};
        var proceed = document.getElementById('proceed');
        var cdWrap = document.getElementById('cdWrap');
        var cd = document.getElementById('cd');
        var cancelBtn = document.getElementById('cancelAuto');
        var timer = null, remain = delay;
        function setProceedState(disabled, text){
          if(proceed){ if(disabled) proceed.setAttribute('disabled','true'); else proceed.removeAttribute('disabled'); if(text) proceed.textContent = text; }
        }
        function startCountdown(ev){
          if (!hasDelay || delay <= 0) { return; }
          ev.preventDefault();
          cdWrap && (cdWrap.style.display = 'block');
          if (cancelBtn) cancelBtn.style.display = 'inline-block';
          setProceedState(true, '准备跳转…');
          remain = delay;
          if (cd) cd.textContent = String(remain);
          timer = setInterval(function(){
            remain -= 1;
            if (cd) cd.textContent = String(remain);
            if (remain <= 0) {
              clearInterval(timer); timer=null;
              window.location.href = url;
            }
          }, 1000);
        }
        if (proceed) { proceed.addEventListener('click', startCountdown); }
        function cancelCountdown(){
          if (timer) { clearInterval(timer); timer=null; }
          setProceedState(false, '继续前往');
          cdWrap && (cdWrap.style.display = 'none');
          if (cancelBtn) cancelBtn.style.display = 'none';
        }
        if (cancelBtn) { cancelBtn.addEventListener('click', cancelCountdown); }

        // 复制
        function showToast(msg){
          var t = document.getElementById('toast');
          if(!t) return;
          t.textContent = msg;
          t.hidden = false;
          t.classList.add('show');
          setTimeout(function(){ t.classList.remove('show'); t.hidden = true; }, 1600);
        }
        var copyLink = document.getElementById('copyLink');
        var copyQuote = document.getElementById('copyQuote');
        copyLink && copyLink.addEventListener('click', function(){
          var u = this.getAttribute('data-url');
          if(!u) return;
          navigator.clipboard && navigator.clipboard.writeText(u).then(function(){ showToast('已复制链接'); });
        });
        copyQuote && copyQuote.addEventListener('click', function(){
          var q = this.getAttribute('data-quote');
          if(!q) return;
          navigator.clipboard && navigator.clipboard.writeText(q).then(function(){ showToast('已复制引用'); });
        });
        

        // QR code modal (offline generation)
        var showQR = document.getElementById('showQR');
        var qrModal = document.getElementById('qrModal');
        var closeQR = document.getElementById('closeQR');
        var qrContainer = document.getElementById('qrImg');
        var qrcodeInstance = null;
        function openQR(){
          if(!qrModal) return;
          if(qrContainer){
            // 清空容器以避免重复渲染
            qrContainer.innerHTML = '';
            try {
              qrcodeInstance = new QRCode(qrContainer, {
                text: url,
                width: 220,
                height: 220,
                correctLevel: (window.QRCode && QRCode.CorrectLevel && QRCode.CorrectLevel.M) ? QRCode.CorrectLevel.M : 1
              });
            } catch (e) {
              // 回退：若库不可用，则保持原链接文本
            }
          }
          qrModal.hidden = false; qrModal.classList.add('open');
        }
        function closeQRModal(){ if(!qrModal) return; qrModal.classList.remove('open'); qrModal.hidden = true; }
        showQR && showQR.addEventListener('click', openQR);
        closeQR && closeQR.addEventListener('click', closeQRModal);
        qrModal && qrModal.addEventListener('click', function(ev){ if(ev.target === qrModal){ closeQRModal(); } });
      })();
    </script>
{% if baidu_tongji_id is defined and baidu_tongji_id != "" %}
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?{{ baidu_tongji_id }}";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>
{% endif %}

{% if google_analytics_id is defined and google_analytics_id != "" %}
<script async src="https://www.googletagmanager.com/gtag/js?id={{ google_analytics_id }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{ google_analytics_id }}');
</script>
{% endif %}

  </body>
</html>
